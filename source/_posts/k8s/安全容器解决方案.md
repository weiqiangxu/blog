---
title: 安全容器解决方案
index_img: /images/bg/k8s.webp
banner_img: /images/bg/5.jpg
tags:
  - kubernetes
categories:
  - kubernetes
date: 2023-04-23 18:40:12
excerpt: 比较现在开源的所有安全容器相关的技术
sticky: 1
---

### 一、什么是安全容器

#### 1.概念

安全容器是一种为应用程序提供高度隔离和安全性的技术，它可以控制应用程序访问系统资源和数据的权限，并提供虚拟化，使应用程序能够在隔离的环境中运行。安全容器的概念最早是由 FreeBSD 操作系统的开发者 Jails 提出的，他们在 2000 年左右将这一概念引入 FreeBSD 操作系统。后来，Linux 容器技术发展起来后，安全容器概念也逐渐被引入其中。

#### 2.kubenertes

目前k8s或者docker底层容器，通常是依赖于runc，而runc的资源隔离方案底层是 Linux 容器技术。它利用 Linux 内核提供的一些隔离机制，如 namespace、cgroup、seccomp等。具体来说，namespace 用于隔离应用程序的进程空间、网络、文件系统等，cgroup 用于限制应用程序的资源使用，seccomp 用于限制应用程序对系统调用的访问。runc 利用这些机制，将应用程序运行在一个隔离的环境中，从而提高应用程序的安全性和可靠性。但在实际运行中，仍是由宿主机向容器直接提供网络、存储、计算等资源，然而容器的安全性可以概括为两点： a.不会对主机造成影响。b.不会对其他容器造成影响。Docker的不安全表现在共用内核问题、Namespace还不够完善。具体表现：

1. 资源未隔离
``` bash
# 容器内部输出与宿主机一致
$ free -m 
# 看到宿主机的进程
$ top
# /dev设备未隔离:容器内查看所有设备与宿主机一致
$ ls /dev
# 如果runc容器没有隔离/sys
# 那么容器内的进程可以轻易地获取主机上的内核信息，如主机的CPU或者内存信息。
# 这意味着容器内的恶意进程可以利用这些信息来绕过安全控制，访问主机上的敏感资源或破坏主机的系统
$ ls /sys
# /proc 未完全隔离
# runc 在默认情况下不隔离 /proc，这意味着容器中的进程可以看到宿主机上的进程
$ ls /proc
```
2. 内核模块未隔离。
3. SELinux、time、syslog等所有现有Namespace之外的信息都未隔离。
4. Root用户未隔离（如果Root用户未隔离，容器中的进程可以通过提升权限来访问宿主机中的资源）

### 二、集成安全容器有什么价值

1. 提升安全性：容器间完全隔离，容器内部无法访问其他容器内部资源。
2. 提升稳定性：因为隔离的原因，容器只能影响到自身内部无法影响到其他容器以及宿主机；
3. 更细粒度资源控制：安全容器可以提供更细粒度的资源控制，包括CPU、内存、网络等方面，从而更好地管理和控制容器的资源使用。

### 三、安全容器相关的技术有哪些

1. gvisor Go编写的应用程序内核、虚拟机监控程序（virtual machine monitor）、内部Runsc替代runc集成到docker、用户态的内核；

![机器级虚拟化-性能消耗大安全性高](/images/机器级虚拟化-性能消耗大安全性高.png)

![规则级别虚拟化-类似runc](/images/规则级别虚拟化.png)

![gvisor的虚拟化.png](/images/gvisor的虚拟化.png)

2. firecracker 亚马逊AWS开源，依赖KVM，轻量级虚拟机管理器VMM，QEMU替代品，资源利用率更高，不支持所有设备类型；

![什么是QEMU和firecraker](/images/什么是QEMU和firecraker.jpeg)

3. openeuler StratoVirt 开放原子开源基金会孵化及运营，是基于Linux内核的虚拟机（KVM）的开源轻量级虚拟化技术,轻量级的虚拟机管理器,企业级虚拟化VMM(Virtual Machine Monitor)

![StratoVirt架构](/images/StratoVirt-arch.jpg)

![StratoVirt.iSulad接入安全容器](/images/iSulad接入安全容器.png)

4. QEMU 模拟计算机硬件的开源软件,可用作虚拟机管理器，功能齐全，成熟完善，支持所有设备

![qemu-kvm架构图](/images/qemu-kvm架构图.png)

![qemu-kvm组件图](/images/qemu-kvm组件图.png)

5. kata-containerd Intel开源项目合并,轻量级的容器运行时

![katacontainers和传统容器(runc)区别](/images/katacontainers_traditionalvskata_diagram.jpg)

![docker和kata-runtime](/images/docker和kata-runtime.png)

![kata与k8s](/images/kata与k8s.svg)

![kata与k8s示意图](/images/katacontainers_architecture_diagram.jpg)

![kubelet执行create pod之后逻辑架构](/images/katacontainers-e2e-with-bg.jpg)

![kata3.x-架构](/images/kata3.x-architecture.png)

![kata3.0可选的hypervisor-config](/images/hypervisorConfigInkata-3.0.png)

### 四、安全容器集成方案

#### 1.kata-container
#### 2.gvisor
#### 3.openeuler StratoVirt

### Q&A

1. runc底层原理

- namespace 用于隔离应用程序的进程空间、网络、文件系统等
- cgroup 用于限制应用程序的资源使用 
- seccomp 用于限制应用程序对系统调用的访问


### 相关资料

- [https://firecracker-microvm.github.io/](https://firecracker-microvm.github.io/)  
- [https://gvisor.dev/](https://gvisor.dev/)
- [https://katacontainers.io/](https://katacontainers.io/)
- [https://www.qemu.org/](https://www.qemu.org/)
- [https://docs.openeuler.org/zh/docs/22.03_LTS_SP1/docs/StratoVirt/](https://docs.openeuler.org/zh/docs/22.03_LTS_SP1/docs/StratoVirt/%E5%AE%89%E8%A3%85StratoVirt.html)
- [https://www.linux-kvm.org/page/Main_Page](https://www.linux-kvm.org/page/Main_Page)
- [https://libvirt.org/](https://libvirt.org/)
- [https://kubevirt.io/](https://kubevirt.io/)
- [https://selinuxproject.org/page/Main_Page](https://selinuxproject.org/page/Main_Page)
- [如何安装启动StratoVirt](https://www.openeuler.org/zh/blog/wangzhigang/howToUseStratoVirt.html)
- [https://gitee.com/openeuler/stratovirt](https://gitee.com/openeuler/stratovirt)
- [stratovirt设计](https://gitee.com/openeuler/stratovirt/blob/master/docs/design.ch.md)
- [华为 | 基于Rust的下一代虚拟化平台-StratoVirt](https://rustmagazine.github.io/rust_magazine_2021/chapter_3/hw_rust_stratovirt.html)
- [已有Qemu了，为什么还要StratoVirt](https://cloud.tencent.com/developer/article/1761013)
- [Qemu架构图](https://zhuanlan.zhihu.com/p/72484589)
- [KVM & Qemu &](https://cdn.jiwenkang.com/QEMU.html)
- [Qemu架构图](https://wiki.qemu.org/Documentation/Architecture)
- [kata如何选择hypervisors](https://github.com/kata-containers/kata-containers/blob/main/docs/hypervisors.md)
- [kata博客架构图](https://github.com/kata-containers/documentation/blob/master/design/architecture.md)
- [run kata containers with kubernetes](https://github.com/kata-containers/kata-containers/blob/main/docs/Developer-Guide.md#run-kata-containers-with-kubernetes)